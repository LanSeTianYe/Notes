时间：2022-07-16 10:39:39

参考：

1. [go-ethereum](https://github.com/ethereum/go-ethereum)
2. [rinkebyfaucet](https://rinkebyfaucet.com/)
3. [private-network](https://geth.ethereum.org/docs/interface/private-network)
4. [remix](https://remix.ethereum.org/)
5. [web3](https://ethereum.org/zh/web3/)
6. [以太坊白皮书](https://ethereum.org/zh/whitepaper/)
7. [精通以太坊：开发智能合约和去中心化应用](https://weread.qq.com/web/reader/c0532740718247c1c0545f7)

## 区块链 以太坊

区块链 2.0，是一个去中心化平台，提供分布式账本，可以运行智能合约（就是代码）。货币名字以太币。

有两种账户都用地址标识，外部账户（Externally Ownerd Account）和 合约账户。合约账户是用户部署合约的一个地址（合约地址根据发送部署合约交易的用户信息可以推算出来）。

账户可以发起交易，交易包含 `From` 和 `To` 这两个重要属性。

如果交易的接收者是外部账户，发起的交易就是一笔转账交易。

如果交易的接收者是合约账户，发起的交易是一次合约调用。

被调用的合约在EVM虚拟机上执行。合约用 `Solidity` 或其他语言编写，然后部署在以太坊上。

交易会被打包进区块，一个区块包含多笔交易。

区块会引用父区块，从而形成链式结构。

区块链的起始块是创世块。

在以太坊中，区块可以有叔块。所有区块内容不重复。

测试合约的时候会把合约部署到测试网络，合约部署之后码就不可以变更，因此需要充分的测试和代码审查，避免漏洞出现。

当合约测试通过之后，可以发布到以太坊主网络。

使用合约提供的函数，可以构造我们的DApp。

### 节点类型

* 全节点：存放全部数据，对块和交易进行验证。如 Geth (Go 以太坊客户端)。
* 轻节点：不存链上历史数据，只保存区块当前状态。可以对区块和交易进行验证。
* 远程客户端：不存历史数据，不验证区块和交易，只发起交易。如 `MetaMask`。

### 网络类型

#### 主网络

以太坊主网络，实际运行的以太坊网络。目前交易的 `ETH` 都在主网络上，

#### 测试网络

以太坊测试网络，模拟运行的以太坊网络，可以在上面部署合约测试以太坊的功能。里面的数据没有实际价值。

测试网络都有对应的 Faucet（水龙头），可以从里面提取对应的测试网络货币，用于发送交易。

可以在 `MetaMask` 里面找到水龙头的地址。

####　私有网络

本地启动以太网客户端，不连接到主网络。可以在控制台和链交互。

注：启动之前需要初始化区块配置，不然会直接连接到著网络。具体配置可参考以太坊官网。

```shell
# 启动节点
./geth --datadir data --networkid 12345 --http --http.addr "192.168.0.201" --http.vhosts "*" --allow-insecure-unlock

# 交互控制台
./geth --datadir data attach
```

### 账户 

账户里面包含如下数据：

* nonce：当前账户地址已发送成功的的交易数量，用于确保每笔交易只能处理一次的计数器。
* 账户当前的以太币余额。
* 账户的合约代码（若有）。
* 账户的存储（默认为空）。

账户分为外部账户（Externally Ownerd Account）和内部账户（合约）。

外部账户可以发起交易。

合约账户也可以有以太币，同时可以执行合约代码，完成一些业务。合约可以调用其他合约。

在以太坊中合约用一个地址标识。比如 `0xF45717552f12Ef7cb65e95476F217Ea008167Ae3` 这个地址对应一个合约，在合约代码内部可以直接使用这个地址初始化一个级合约然后调用合约的方法，比如 `Government(0xF45717552f12Ef7cb65e95476F217Ea008167Ae3).round()`，也可以通过 `call` 或者 `delegatecall` 调用合约。

合约地址:[Government](https://etherscan.io/address/0xf45717552f12ef7cb65e95476f217ea008167ae3#readContract)

### 交易

交易内容如下：

* 消息接收者。
* 用于识别发送者身份的数字签名。
* 从发送者转账到接收者的以太币金额。
* 一个可选数据字段。
* STARTGAS 值，表示允许交易运行的最大计算步骤数。
* GASPRICE 值，表示发送者每个计算步骤支付的费用。

### 虚拟机（Enthereum Virtual Machine）

在内存中运行，不使用寄存器，基于栈的虚拟机。

* 执行智能合约。
* 验证交易。

### 智能合约

合约运行在EVM中，每个全节点都有机会运行所有的合约。

合约的数据可以保存在内存中，也可以持久化存储到磁盘中。

`Solidity` 是比较流行的以太坊合约语言，可以通过 Remix 在线编写。

注：由于虚拟机执行和合约调用的原因，以及合约代码是所有人可见的，写合约要注重安全，可能会因为一些不安全的业务逻辑，被黑客攻击。

注：在写合约的时候不要用使用如时间(now)、区块哈希、合约发起者(xt.original)等可被控制或有歧义的数据作为判断条件。

**存取数据合约代码如下：**

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.7.0 <0.9.0;
contract Storage {
    uint256 number;
    function store(uint256 num) public {
        number = num;
    }
    function retrieve() public view returns (uint256){
        return number;
    }
}
```

合约编译之后会产生两部分内容，分别是 `合约字节码` 和 `ABI (Application Binary Interface)` 合约接口文档。

### DAPP（Decsntarlized Application）

基于以太坊开发的应用程序，后端对应以太坊的合约，前端由 `JavaScript` 实现。

Swarm协议、Web3(web3.js)、Whisper 协议。

### ICO (Initial Coin Offering)

是指在区跨链平台发行代币众筹资金。类似于IPO。

流程：

1. 创建两个合约，一个代币合约，一个ICO合约。
2. 代币合约用于管理代币，初始化时创建者拥有所有的代币。ICO合约用户众筹资金，提供使用以太币换取代币的函数，代币拥有者会把一部分代币授权给ICO合约。
3. 用户向ICO合约发送以太币换取代币。ICO合约调用代币合约把取得授权的代币中的对应数量的代币发送给用户。
4. 至此代币拥有者获取到了以太币（资金），用户获取到了对应的权益（代币）。
