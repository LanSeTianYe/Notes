时间：2020-11-13 15:24:24

参考：

1. HTTP 权威指南

##  TCP 性能

TCP 连接数据发送要经以下几个过程。

1. 建立连接（三次握手）。 耗时 t1
2. 客户端发送数据。            耗时 t2
3. 服务端处理数据。            耗时 t3
4. 服务端响应数据。            耗时 t4
5. 关闭连接。                        耗时 t5。

其中 t5 可以忽略。

设: T = t1+t2+t3+t4+t5 = t1+t2+t3+t4

### TCP 连接建立

TCP 连接建立需要耗费一定时间，如果连接建立之后发送的数据量比较小，会出现连接建立耗时较整个传输过程时间比重较大的问题。

即 `t1/T` 比值较大，可以通过复用TCP连接，减少 `t1` 所占比重。

### 延迟确认

TCP服务器接收TCP数据后会向TCP客户端发送确认数据，确认数据会附加在其它数据块上发送，如果在一段时间(延迟)没有其它数据块要发送，则会单独发送确认数据。如果没有数据发送，就会等待一段时间。延迟时间通常是 100～200毫秒。

### TCP 慢启动

TCP连接建立之后发送的数据块数量是指数递增的如 (2^0 => 2^1=>2^2=>2^3 ... )。第一次发送1块，当这块数据确认收到之后再发送2块，当2块都确认收到之后再发送4块，以此类推。

### Nagle算法

Nagle算法尽量发送全尺寸的分组（约1600字节），非全尺寸的数据会在收到其它全尺寸数据响应之后发送，由于延迟确认的存在，响应可能延迟100~200毫秒，如果缓存中的数据达到全尺寸大小也会进行发送。

### TCP端口耗尽

TCP连接关闭之后，操作系统会在内存中缓存之前的IP地址和端口信息，缓存时间2分钟左右，缓存中的端口不能再次使用。

`客户端IP，客户端端口，服务器IP，服务器端口`

当在客户端建立到固定服务器的连接时，客户端IP，服务器IP，服务器端口都不变，可以改变的只有客户端端口，操作系统最大端口个数 (2^16 = 0 ~ 65535)，在两分钟内只能建立这么多端口。