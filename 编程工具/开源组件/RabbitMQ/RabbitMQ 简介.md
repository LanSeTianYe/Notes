时间： 2020-08-19 11:44:44
参考：

1. [记一次RabbitMQ连接阻塞，全部队列不消费异常](https://www.wolzq.com/%E8%AE%B0%E4%B8%80%E6%AC%A1RabbitMQ%E8%BF%9E%E6%8E%A5%E9%98%BB%E5%A1%9E%EF%BC%8C%E5%85%A8%E9%83%A8%E9%98%9F%E5%88%97%E4%B8%8D%E6%B6%88%E8%B4%B9%E5%BC%82%E5%B8%B8/)

## 简介
消息队列。

消息接收方式：推送。

通过组合交换器、队列、和绑定的组合，实现消费场景灵活配置。

### 消息

每条消息都包含一个路由键。

### 通道

客户端和RabbitMQ服务器建立连接之后，在单个TCP连接内建立通道进行数据交互。减少建立TCP连接的个数。提高性能。

* 发送方确认：消息被持久化到RabbitMQ服务器上之后，RabbitMQ服务器异步发送消息给发送方，发送方根据响应进行处理。

### 交换器

消息到达RabbitMQ服务器后，第一个到达的地方。

消费到达交换器之后根据路由规则路由到对应的队列。路由规则是通过判断消息的路由键进行判断的。

**交换器类型:**

* direct：消息被投递到交换器绑定的和消息路的由键相同的队列。
* fanout：消息被投递到交换器绑定的所有队列。
* topic：消息被投递到交换器绑定的符合匹配规则的队列。匹配贵则支持通配符, `*`匹配任意个字符， `#` 所有路由键。
* headers：性能较低，不推荐使用。

`fanout` 类型的交换器，绑定N个队列，既可以实现消息被N个消费者消费。

**交换器属性:**

* 类型：交换器的类型。
* 持久化：服务器重启之后交换器是否不被删除。
* 自动删除：交换器长时间没有使用是都自动删除。

### 队列

消息发送到RabbitMQ之后，通过交换器根据绑定规则最终路由到队列。等待消费者消费。

* 消息发送方式。服务器发送消息给建立的连接。消费者可以持续接收或者一次接收一个。
* 创建队列。创建队列的时候如果不指定队列名称，服务器会自动分配一个名字，并返回。如果队列已存在则不会再次创建。
* 临时队列。队列可以配置自动删除，当没有消费者订阅的时候自动删除。
* 消费者拒绝消息：消费者可以主动拒绝接收的消息，拒绝时传递的参数为true的话，该消息会被重新发送给其它消费者。拒绝时传递的参数为false的话，消息会被放入死信队列。
* 死信队列。拒绝的直接删除的消息会放在死信队列。
* 私有队列。当前客户端可用。
* 消费者。消费者需要对消费的消息发送确认信息（ACK）到服务器。没有确认的消息会再次发送给队列的订阅者。在消费者发送确认消息之前，服务器不会再次向该消费者发送消息。
* 多消费者。当有多个消费者订阅队列的时候，队列中的一条消息，只会发送给其中一个消费者。
* 自动删除。没有消费者订阅的时候自动删除队列。
* 绑定多个交换器。队列可以绑定到多个交换器。
* 默认绑定：队列默认会绑定到默认的 direct 交换器。路由键是队列的名字。
* 绑定多个交换器：

### 绑定 

把队列和交换器绑定在一起。符合路由规则的消息将会从交换器发送到队列，不同类型的交换器路由规则不同。

* `fanout`：消息直接发送到队列。
* `direct`：消息会发送到消息的路由键和绑定的路由键相同的队列。
* `topic`：消息会发送到消息的路由键和绑定的路由键匹配的队列。

### vhost

虚拟主机，不同的vhost相互隔离，每个vhost都拥有自己的的交换器、队列和绑定。vhost可以迁移到其它服务器上。


### 集群

假设有 `A(磁盘节点)`、`B(磁盘节点)`、`C(内存节点)`三个Rabbit服务器组成集群。集群中每一个节点都有 交换器、队列和绑定的全部元数据。磁盘节点需要把元数据同步到磁盘中，内存节点只把元数据存储在内存中。在集群中创建交换器、队列、绑定的时候，所有的存活的磁盘节点保存成功之后能创建完成，如果没有磁盘节点则不能创建和修改这些信息。向磁盘中保存会耗费一定的时间，因此集群中注意磁盘节点的数量。

在集群中如果队列是持久化的，当队列所在的那个节点异常之后，则不能再创建原来的队列，需要等到原节点重新加入之后才能创建。如果队列不是持久化的，则节点异常之后，队列数据消失，此时可以在其它节点创建原来的队列。

镜像队列，创建队列的时候可以指定镜像队列的位置，指定之后对应的机器上会有一份该队列的备份，当主队列不能使用的时候，镜像队列会替代主队列提供服务。

### Warren

高可用机制，不同于集群。同一时间只有一个节点提供服务，当节点异常之后，其它的节点会替代异常节点提供服务，所有节点有相同的元数据。

### Shavel

Rabbit 服务之间的数据同步插件，负责将数据从一个服务器同步到另一个服务器。





