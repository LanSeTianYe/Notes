## 需要考虑的内容

1. 导出的报表可以很方便的被导入到系统中。  
2. 通用性，对所有的普通的JAVA类都适用。  

## 说明
1. 使用注解来标识字段的含义(对应的汉语意思),在导出数据的时候，把字段的含义添加到表头，在表头里面添加字段名字对应的批注，导入报表的时候，根据批注里面的字段名字获取对应的 `set` 方法,然后调用Set方法为字段赋值。

## 怎么使用
1. 增加了一个注解类。
        
        @Retention(RetentionPolicy.RUNTIME)
        @Target(ElementType.FIELD)
        public @interface FiledMeaning {
            String value();
        }
        
2. 在实体中增加注解,注解的内容就是导出报表的表头元素。

        @FiledMeaning("任务Id")
        private Long id;


3. 在程序中调用公共的导入导出方法。

        //导出
        public static void writeListObjToResp
        (HttpServletResponse response, List<?> objList, String fileName, Class dataClass)
        //导入
        public static List<Object> readDataFromReq(HttpServletRequest request, Class dataClass)
4. 导入导出方法的代码。

        package com.enerbos.common.util;
        
        import com.enerbos.common.EnerbosException;
        import jxl.Sheet;
        import jxl.Workbook;
        import jxl.read.biff.BiffException;
        import jxl.write.*;
        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.web.multipart.MultipartFile;
        import org.springframework.web.multipart.MultipartHttpServletRequest;
        
        import javax.servlet.http.HttpServletRequest;
        import javax.servlet.http.HttpServletResponse;
        import java.io.IOException;
        import java.io.UnsupportedEncodingException;
        import java.lang.reflect.Field;
        import java.lang.reflect.InvocationTargetException;
        import java.lang.reflect.Method;
        import java.text.ParseException;
        import java.text.SimpleDateFormat;
        import java.text.DateFormat;
        import java.util.*;
        
        /**
         * All rights Reserved, Designed By 翼虎能源
         * Copyright:    Copyright(C) 2015-2015
         * Company       北京翼虎能源科技有限公司
         *
         * @author       sunfeilong
         * @version      1.0
         * @date         2016/1/27 16:40
         * @Description  keyintl
         */
        
        public class ReportFormUtil {
        
            /**
             * 把List里面的对象信息写入到response中, 适用于所有的普通的Java对象
             * @param response
             * @param objList    数据列表
             * @param fileName   文件名
             * @param dataClass  数据类型,对应的Java类
             */
            public static void writeListObjToResp(HttpServletResponse response, List<?> objList, String fileName, Class dataClass) {
        
                try {
                    fileName = new String(fileName.getBytes("UTF-8"), "ISO8859-1");
                } catch (UnsupportedEncodingException e) {
                    throw new EnerbosException("文件名的编码格式非法","");
                }
        
                response.setCharacterEncoding("UTF-8");
                response.setContentType("application/x-msdownload");
                response.setHeader("Content-disposition", "attachment; filename=" + fileName + ".xls");
        
                WritableWorkbook book = null;
                try{
        
                    book = Workbook.createWorkbook(response.getOutputStream());
                    WritableSheet sheetOne = book.createSheet("第一页", 0);
                    List<String> titleList = new ArrayList<>();
                    Map<String, String> fieldAndMethodMap = new HashMap<>();
                    //获取所有对象的所有字段
                    Field[] fields = dataClass.getDeclaredFields();
                    if(fields == null || fields.length <= 0) {
                        throw new EnerbosException("报表的内容为空","");
                    } else {
                        for(int i = 0 ;i < fields.length; i++) {
                            String fieldName = fields[i].getName();
                            titleList.add(fieldName);
                            //获取字段的注解,把注解的内容设置为表头，把字段的名字设置为批注，方便文件的导入
                            FiledMeaning filedMeaningObj = fields[i].getAnnotation(FiledMeaning.class);
                            Label label = null ;
                            if(filedMeaningObj == null) {
                                //第一个参数是列，第二个参数行，第三个参数内容，行和列都从零开始
                                label = new Label(i, 0, fieldName);
                            } else {
                                String fieldMeaning = filedMeaningObj.value();
                                label = new Label(i, 0, fieldMeaning);
                            }
                            //添加批注
                            WritableCellFeatures cellFeatures = new WritableCellFeatures();
                            cellFeatures.setComment(fieldName);
                            label.setCellFeatures(cellFeatures);
                            sheetOne.addCell(label);
                            Method[] methods = dataClass.getMethods();
                            //根据字段生成对应的get方法的名字
                            String temp = new String(fieldName);
                            String methodName = "get" + temp.replaceFirst(String.valueOf(temp.charAt(0)), String.valueOf(temp.charAt(0)).toUpperCase());
                            for(Method method : methods) {
                                //忽略大小写匹配
                                if(method.getName().equals(methodName)) {
                                    fieldAndMethodMap.put(fieldName, method.getName());
                                }
                            }
                        }
                    }
        
                    if(objList != null && objList.size() > 0) {
                        //把数据内容写入到表格中
                        for(int j = 0 ; j < objList.size(); j++) {
                            for(int k = 0 ; k < titleList.size(); k++) {
                                //生成方法
                                Method method = dataClass.getMethod(fieldAndMethodMap.get(titleList.get(k)));
                                //调用方法并把获取的数据写入到表格中
                                Object o = method.invoke(objList.get(j));
                                Class<?> returnType = method.getReturnType();
                                Label label = null;
                                if(returnType.getName().equals("java.util.Date")) {
                                    DateFormat fmtDateTime = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
                                    label = new Label(k, j+1,fmtDateTime.format(o));
                                } else {
                                    label = new Label(k, j+1,String.valueOf(o));
                                }
                                sheetOne.addCell(label);
                            }
                        }
                    }
                    book.write();
                    response.getOutputStream().flush();
                } catch (IOException e) {
                    throw new EnerbosException("创建工作文件出错  info:!"+e.getMessage(), "");
                } catch (WriteException e) {
                    throw new EnerbosException("向表格中添加数据出错!info:!" + e.getMessage(), "");
                } catch (NoSuchMethodException e) {
                    throw new EnerbosException("没有对应的方法 info"+e.getMessage(),"");
                } catch (IllegalAccessException e) {
                    throw new EnerbosException("不合法的访问 info"+e.getMessage(),"");
                } catch (InvocationTargetException e){
                    throw new EnerbosException("调用目标方法异常 info"+e.getMessage(),"");
                } finally {
                    if (book != null) {
                        try {
                            book.close();
                        }catch (Exception e) {
                            throw new EnerbosException("流关闭错误","");
                        }
                    }
                }
            }
        
            /**
             * 读取上传的文件
             * @param request
             */
            public static List<Object> readDataFromReq(HttpServletRequest request, Class dataClass) throws EnerbosException{
                List<Object> returnList = null;
                try {
                    List<MultipartFile> files = ((MultipartHttpServletRequest) request).getFiles("excelFile");
                    Map<String, Method>  fieldAndMethodMap = new HashMap<>();
                    if (files == null || files.size() <= 0) {
                        throw new EnerbosException("请上选择要导入的文件!","");
                    }
                    for(MultipartFile multipartFile : files) {
                        Workbook book = Workbook.getWorkbook(multipartFile.getInputStream());
                        Sheet sheet = book.getSheet(0);
                        //获取对象的字段
                        Field[] fields = dataClass.getDeclaredFields();
                        if(fields == null || fields.length <= 0) {
                            throw new EnerbosException("对象没有字段","");
                        }
                        Method[] methods = dataClass.getMethods();
                        if(methods == null || methods.length <=0) {
                            throw new EnerbosException("对象没有方法", "");
                        }
                        //所有方法的集合
                        Map<String, Method> methodMap= new HashMap<>();
                        for(Method method :  methods) {
                            methodMap.put(method.getName(), method);
                        }
                        //生成字段名和对应的set方法对应的 Map
                        for(Field field : fields) {
                            String fieldName = field.getName();
                            String appendGetMethodName = "set" + fieldName.replaceFirst(String.valueOf(fieldName.charAt(0)), String.valueOf(fieldName.charAt(0)).toUpperCase());
                            if(methodMap.get(appendGetMethodName) != null) {
                                fieldAndMethodMap.put(fieldName,methodMap.get(appendGetMethodName));
                            }
                        }
                        //获取表格数据的第一行,
                        List<String> excelFieldList = new ArrayList<>();
                        for(int i = 0 ; i < sheet.getColumns(); i++) {
                            excelFieldList.add(sheet.getCell(i,0).getCellFeatures().getComment());
                        }
                        returnList = new ArrayList<>();
                        for(int i = 1 ; i < sheet.getRows(); i++) {     //行
                            //初始化对象
                            Object o = dataClass.newInstance();
                            for(int j = 0 ; j < excelFieldList.size(); j++) {
                                Method method = fieldAndMethodMap.get(excelFieldList.get(j));
                                Class<?> [] params = method.getParameterTypes();
                                String type = params[0].getName();
                                if(type.equals("java.lang.String")) {
                                    method.invoke(o, new String(sheet.getCell(j,i).getContents()));
                                } else if(type.equals("java.util.Date")) {
                                    System.out.println(sheet.getCell(j,i).getContents());
                                    DateFormat fmtDateTime = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
                                    method.invoke(o, fmtDateTime.parse(sheet.getCell(j,i).getContents()));
                                } else if(type.equals("java.lang.Long")) {
                                    method.invoke(o, new Long(sheet.getCell(j,i).getContents()));
                                }
        
                            }
                            returnList.add(o);
                        }
                    }
                    return returnList;
                } catch (EnerbosException e) {
                    throw new EnerbosException(e.getMessage(),"");
                } catch (IOException e) {
                    throw new EnerbosException("读取上传的文件失败,请注意文件的格式!","");
                } catch (BiffException e) {
                    throw new EnerbosException("创建WookBook失败!","");
                } catch (IllegalAccessException e) {
                    throw new EnerbosException("初始化对象出错!","");
                } catch (InstantiationException e) {
                    throw new EnerbosException("初始化对象出错!","");
                } catch (InvocationTargetException e) {
                    throw new EnerbosException("调用方法出错!","");
                } catch (ParseException e) {
                    throw new EnerbosException("日期格式转换错误!","");
                }
            }
        }
